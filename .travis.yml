language: java

dist: bionic
os: linux

install: skip

if: tag is blank

notifications:
  email: false

addons:
  apt:
    packages:
      - postgresql-12
      - postgresql-client-12
  sonarcloud:
    organization: 'bbortt-github'
    token:
      secure: 'GiBbIV9/Rf/scaC/gAqw5+gp1n2Lv2BMWiTge5gkHMJGz93QEIlfjuqDe2vfWYrFRa4fXZmYDjTn1ZdppRdvfV25UsN9udH4ItUyMtzdSoY4+XOdCYQ29e4sVVl+oo+m0A5x3KvnLIwIbWapHkNjNDz8vwpafYOEzJf6dIPzXvpjgYv6P4VZkEJPcw0O5DMYPLFe0zE11KFkdPczwdKdbDMuDZB+8VM/JuJcDw9Oz+B2j5TFlZeCj7sOq+ZMEKR72kaOr8yrH23FO/PTD/qwKKl0/0sJy66aPRaUwU0c5cIm5U0+/OEzPeTifFL3Xrk3uLlkWMREWhz5C5ehYItsQi+igMFUnhRxSq/KnoUqjiUs3RJ00QH/Xq+gxF28Yq51KmzXSMWHfgHnzK5ZVvOt1RHceK3tD0WaVpRtfYIuzoTsKUd/uBiGKIUk9EmJNsZBSmqsdbKV05Xwjun9m2lCGS9x8fKlL/z6Zf8rJlu5EWohhrx+XJlxvbs30qKfIo/8rCPaolSp5SghM4cNPmZ+P89I746sKbqsBAyH1E1FlDP1qwUgQbfX0+xNuSjRjm98f4vqd0yh+LRku+Hhtcmr7L3wGveB8EC0bjJ5o7uVRc6Z73oGylHrjAi47SmJDn6u5lU+UXl0HHZ+Uv9gQ2ENuBVKklo9H942YtBZN6xdwRE='

jobs:
  include:
    # OracleJDK - Java 11 (lts, main build with Sonar)
    - env: MAIN_BUILD='true'
      jdk: openjdk11
    # OpenJDK - Java 13 (latest)
    - env: MAIN_BUILD='false'
      jdk: openjdk13

before_install:
  - sudo sed -i 's/port = 5433/port = 5432/' /etc/postgresql/12/main/postgresql.conf
  - sudo cp /etc/postgresql/{9.3,12}/main/pg_hba.conf
  - sudo pg_ctlcluster 12 main restart

before_script:
  - psql -c "CREATE DATABASE event_planner_integration;" -U postgres
  - psql -c "CREATE USER event_planner WITH PASSWORD 'event_planner_password';" -U postgres
  - psql -c "GRANT ALL PRIVILEGES ON DATABASE event_planner_integration TO event_planner;" -U postgres

script:
  - if [[ "${MAIN_BUILD}" != "" && "${MAIN_BUILD}" == "true" ]]; then export GRADLE_COMMAND="build jacocoTestReport sonarqube"; else export GRADLE_COMMAND="check"; fi
  - ./gradlew dependencyUpdates
  - ./gradlew -Pversion=$TRAVIS_BUILD_NUMBER -Pprod --no-daemon -i ${GRADLE_COMMAND}

after_success:
  - bash <(curl -s https://codecov.io/bash)

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -rf $HOME/.gradle/caches/*/plugin-resolution/

cache:
  - npm
  - directories:
      - $HOME/.gradle/caches/
      - $HOME/.gradle/wrapper/
      - $HOME/.sonar/cache
